# Custom PCAP File Format - ImHex Pattern

这是为 PcapFile.IO 项目的自定义 PCAP 文件格式创建的 ImHex 模式语言文件。

## 文件说明

### custom_pcap.hexpat
主要的 ImHex 模式语言文件，用于解析自定义 PCAP 文件格式。

### custom_pcap.json
模式文件的元数据配置文件，包含格式规范、结构信息和安装说明。

## 自定义 PCAP 文件格式规范

### 文件结构

```
+------------------+
|   PCAP 文件头    |  16 字节
|   (16 bytes)     |
+------------------+
|   数据包头 1     |  16 字节
|   (16 bytes)     |
+------------------+
|   数据包内容 1   |  可变长度
|   (variable)     |
+------------------+
|   数据包头 2     |  16 字节
|   (16 bytes)     |
+------------------+
|   数据包内容 2   |  可变长度
|   (variable)     |
+------------------+
|       ...        |
+------------------+
```

### PCAP 文件头（16 字节）

| 偏移量 | 长度 | 字段名 | 类型 | 描述 |
|--------|------|--------|------|------|
| 0 | 4 | magic_number | u32 | 魔术数，固定值 0xD4C3B2A1 |
| 4 | 2 | major_version | u16 | 主版本号，固定值 0x0002 |
| 6 | 2 | minor_version | u16 | 次版本号，固定值 0x0004 |
| 8 | 4 | timezone_offset | i32 | 时区偏移量（秒） |
| 12 | 4 | timestamp_accuracy | u32 | 时间戳精度（纳秒） |

### 数据包头（16 字节）

| 偏移量 | 长度 | 字段名 | 类型 | 描述 |
|--------|------|--------|------|------|
| 0 | 4 | timestamp_seconds | u32 | 时间戳秒部分（UTC） |
| 4 | 4 | timestamp_nanoseconds | u32 | 时间戳纳秒部分（UTC） |
| 8 | 4 | packet_length | u32 | 数据包长度（字节） |
| 12 | 4 | checksum | u32 | 数据包校验和（CRC32） |

### 数据包内容
- 长度由数据包头中的 `packet_length` 字段指定
- 最大长度：30MB (30 * 1024 * 1024 字节)
- 包含原始网络数据包内容

## 安装和使用

### 安装步骤

1. **复制文件**
   ```bash
   # 将模式文件复制到 ImHex 的模式目录
   cp custom_pcap.hexpat ~/.local/share/imhex/patterns/
   # Windows: 复制到 %APPDATA%\imhex\patterns\
   # macOS: 复制到 ~/Library/Application Support/imhex/patterns/
   ```

2. **重启 ImHex**
   - 关闭 ImHex
   - 重新启动 ImHex

3. **加载模式**
   - 打开一个 .pcap 文件
   - 在 ImHex 中，转到 `Pattern` 菜单
   - 选择 `Load Pattern` 或 `Load Pattern File`
   - 选择 `custom_pcap.hexpat` 文件

### 使用方法

1. **打开文件**
   - 在 ImHex 中打开您的自定义 PCAP 文件

2. **加载模式**
   - 通过 Pattern 菜单加载 `custom_pcap.hexpat`

3. **查看解析结果**
   - ImHex 会自动高亮显示文件结构
   - 在 Pattern Data 视图中查看解析的数据
   - 在控制台中查看验证结果和统计信息

## 功能特性

### 自动检测
- 通过魔术数自动识别文件格式
- 验证版本号确保格式兼容性

### 数据验证
- CRC32 校验和验证
- 数据包长度验证
- 文件完整性检查

### 可视化
- 语法高亮显示文件结构
- 字段级别的数据展示
- 时间戳格式化显示

### 错误检测
- 校验和不匹配警告
- 数据包损坏检测
- 文件格式错误报告

### 统计信息
- 数据包总数统计
- 文件大小信息
- 时间戳范围分析

## 示例输出

当加载模式后，ImHex 会：

1. **自动识别文件格式** - 通过魔术数 `0xD4C3B2A1` 识别为自定义 PCAP 格式
2. **高亮显示结构** - 在 Pattern Data 视图中显示文件头和数据包结构
3. **错误检测** - 如果魔术数不匹配，会显示错误信息
4. **数据解析** - 自动解析所有数据包，显示时间戳、长度和校验和信息

## 故障排除

### 常见问题

1. **模式未加载**
   - 确保文件路径正确
   - 检查 ImHex 版本兼容性
   - 重启 ImHex

2. **解析错误**
   - 检查文件是否为有效的自定义 PCAP 格式
   - 验证魔术数是否正确
   - 确认文件未损坏

3. **校验和不匹配**
   - 这可能是正常的，表示数据包在传输过程中被修改
   - 检查数据包是否完整
   - 验证 CRC32 计算是否正确

### 调试技巧

1. **查看原始数据**
   - 使用 ImHex 的十六进制视图检查原始字节
   - 验证魔术数和版本号

2. **逐步解析**
   - 先验证文件头
   - 再逐个检查数据包
   - 使用 Pattern Data 视图查看解析结果

3. **日志信息**
   - 查看 ImHex 控制台的警告和错误信息
   - 注意校验和不匹配的提示

## 技术细节

### CRC32 算法
模式使用简化的 CRC32 算法进行校验和计算：
- 多项式：0xEDB88320
- 初始值：0xFFFFFFFF
- 最终异或：0xFFFFFFFF

### 字节序
所有多字节字段使用小端序（Little Endian）存储。

### 时间戳格式
- 使用 UTC 时间
- 秒部分：32 位无符号整数
- 纳秒部分：32 位无符号整数
- 精度：纳秒级

## 贡献

如果您发现任何问题或有改进建议，请：

1. 检查现有的问题报告
2. 创建新的问题报告
3. 提交拉取请求

## 许可证

本项目使用 MIT 许可证。详见 LICENSE 文件。

## 相关链接

- [ImHex 官方网站](https://github.com/WerWolv/ImHex)
- [ImHex 模式语言文档](https://docs.werwolv.net/imhex/views/pattern-editor)
- [PcapFile.IO 项目](https://github.com/KimoTech/ZHFP-N12-2412)
