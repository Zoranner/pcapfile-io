# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在本仓库协作开发时的架构与开发指南。

---

## 项目概述

本项目是一个高性能的 PCAP 文件读写库，核心采用 Rust 语言实现，专注于多文件 PCAP 数据集的高效读取、写入、索引、缓存和数据处理。项目采用分层架构，代码全部位于 `src/` 目录下，便于维护和扩展。支持跨平台运行，适用于网络数据分析、数据包处理等场景。

---

## 架构总览

- **核心语言**：Rust
- **分层结构**：
  - `api/`：对外统一 API 接口，隐藏内部实现复杂性，面向用户和上层调用。
  - `business/`：业务逻辑层，负责配置管理、索引系统、缓存策略、数据处理等核心算法。
  - `data/`：数据访问层，负责底层文件读写、数据模型定义、格式解析与生成。
  - `foundation/`：基础设施层，提供错误处理、trait 定义、通用工具和类型支持。
- **测试与示例**：
  - `tests/`：Rust 单元与集成测试。
  - `examples/`：典型用法示例。

---

## 目录结构

```bash
.
├── src/
│   ├── api/           # 用户接口层（统一API）
│   │   ├── mod.rs     # API模块入口
│   │   ├── reader.rs  # 数据集读取器
│   │   └── writer.rs  # 数据集写入器
│   ├── business/      # 业务逻辑层
│   │   ├── mod.rs     # 业务模块入口
│   │   ├── config.rs  # 配置管理
│   │   ├── cache.rs   # 缓存管理
│   │   └── index/     # 索引系统
│   │       ├── mod.rs # 索引模块入口
│   │       ├── manager.rs # 索引管理器
│   │       └── types.rs   # 索引类型定义
│   ├── data/          # 数据访问层
│   │   ├── mod.rs     # 数据模块入口
│   │   ├── models.rs  # 数据模型定义
│   │   ├── file_reader.rs # 单文件读取器
│   │   ├── file_writer.rs # 单文件写入器
│   │   └── formats.rs # 格式解析和生成
│   └── foundation/    # 基础设施层
│       ├── mod.rs     # 基础设施模块入口
│       ├── error.rs   # 错误类型定义
│       ├── types.rs   # 类型和常量定义
│       └── utils.rs   # 工具函数
├── tests/             # 单元/集成测试
├── examples/          # 示例代码
├── docs/              # 设计与说明文档
├── hexpat/            # 十六进制模式文件
├── hooks/             # Git hooks
├── target/            # Rust编译输出目录
├── Cargo.toml         # Rust 配置
├── Cargo.lock         # 依赖锁定
├── README.md          # 项目说明
└── CLAUDE.md          # 开发指南
```

---

## 核心数据流

1. 用户通过 API（src/api/）调用统一接口，进行数据集的读取、写入、索引生成等操作。
2. API 层自动调度 business 层的配置、索引、缓存、数据处理等核心逻辑。
3. business 层根据需要调用 data 层进行底层文件读写、数据模型转换、格式解析。
4. 所有错误、trait、工具和类型由 foundation 层统一提供和管理。
5. 测试和示例通过 API 层驱动全流程，验证各层协作正确性。

---

## 模块职责表

| 模块            | 职责/功能               | 说明                               |
| --------------- | ----------------------- | ---------------------------------- |
| **api/**        | 用户接口层              | 统一 API，隐藏内部复杂性           |
| **business/**   | 业务逻辑/索引/缓存/配置 | 配置管理、索引系统、缓存、数据处理 |
| **data/**       | 数据访问层              | 文件 IO、数据模型、格式解析        |
| **foundation/** | 基础设施                | 错误处理、trait、工具、类型定义    |
| **tests/**      | 单元/集成测试           | Rust 测试用例                      |
| **examples/**   | 示例代码                | 典型用法演示                       |
| **hexpat/**     | 十六进制模式文件        | 用于文件格式验证和调试             |
| **hooks/**      | Git hooks               | 代码质量检查和自动化流程           |
| **docs/**       | 设计文档                | 内部设计文档和架构说明             |

### 详细模块结构

#### api/ 用户接口层
- `mod.rs`: 模块入口，统一导出API
- `reader.rs`: 数据集读取器，提供高级读取功能
- `writer.rs`: 数据集写入器，提供高级写入功能

#### business/ 业务逻辑层
- `mod.rs`: 业务模块入口
- `config.rs`: 配置管理和验证
- `cache.rs`: 文件信息缓存管理
- `index/`: 索引系统
  - `mod.rs`: 索引模块入口
  - `manager.rs`: 索引管理器，负责索引生命周期
  - `types.rs`: 索引相关数据结构

#### data/ 数据访问层
- `mod.rs`: 数据模块入口
- `models.rs`: 核心数据结构定义
- `file_reader.rs`: 单文件读取器
- `file_writer.rs`: 单文件写入器
- `formats.rs`: 格式解析和生成

#### foundation/ 基础设施层
- `mod.rs`: 基础设施模块入口
- `error.rs`: 错误类型定义和处理
- `types.rs`: 类型和常量定义
- `utils.rs`: 工具函数和扩展方法

---

## 开发命令

```bash
# 构建项目
cargo build

# 运行全部测试
cargo test

# 运行指定测试
cargo test test_name

# 性能基准测试
cargo bench

# 运行示例
cargo run --example dataset_usage

# 代码格式检查
cargo fmt --check

# 代码质量检查
cargo clippy

# 生成文档
cargo doc --open
```

---

## 关键技术

- **Rust 分层架构**：api、business、data、foundation 四层解耦，便于维护和扩展。
- **高性能 PCAP 处理**：支持多文件数据集、索引、缓存、批量处理。
- **统一错误处理**：thiserror + 自定义错误类型，异常管理清晰。
- **强类型与文档注释**：所有核心结构和接口均有类型注解和文档说明。
- **测试驱动开发**：tests/ 目录下覆盖单元与集成测试。
- **跨平台支持**：兼容 Windows、Linux、macOS。

### 核心依赖库

- **serde**: 数据序列化/反序列化
- **chrono**: 时间戳处理
- **thiserror**: 错误类型定义
- **log**: 日志记录
- **sha2**: 哈希计算
- **tokio**: 异步运行时（可选）
- **criterion**: 性能基准测试

### 特性支持

- **默认特性**: std（标准库支持）
- **可选特性**: async（异步支持）、alloc（堆分配）、no_std（无标准库）

---

## 重要说明

- 目录结构与文档描述完全一致，便于新成员快速上手。
- 推荐先阅读 `api/` 和 `business/` 目录下的文档注释理解整体流程。
- 测试和示例可直接运行，验证功能和性能。
- 如需扩展新功能，建议遵循现有分层架构，保持代码整洁。

---

## 开发流程

本项目采用简洁高效的开发流程，专注于代码质量和功能实现。

### 核心原则

#### 效率原则

- 并行执行优于顺序执行，识别可同时进行的任务
- 每个阶段输出最小可验证版本，避免过度设计
- 30分钟无进展即停止重新评估方法
- 所有交付物必须能独立部署运行

#### 质量原则

- 代码包含完整类型注解、文档注释，10分钟内可理解
- 零配置运行：一条命令即可启动，包含完整依赖
- 安全优先：输入验证、权限检查、数据保护
- 跨平台验证：Windows、macOS、Linux兼容或明确限制

#### 协作原则

- 技术术语配简要解释，确保理解一致
- 决策记录原因、备选方案、风险评估
- 问题报告包含：描述、复现、影响、解决方案
- 每次交流包含需求编号、设计章节、代码位置引用

### 开发工作流

#### 功能开发流程

1. **需求分析**：明确功能需求、性能要求、约束条件
2. **技术设计**：确定API设计、数据结构、错误处理策略
3. **测试驱动**：先编写测试用例，再实现功能
4. **代码实现**：遵循分层架构，保持代码整洁
5. **质量检查**：运行测试、格式检查、性能验证
6. **文档更新**：更新API文档、示例代码、README

#### 代码质量标准

- **类型安全**：充分利用Rust类型系统，避免运行时错误
- **错误处理**：使用Result类型，提供详细的错误信息
- **性能优化**：零拷贝操作，减少内存分配
- **文档完整**：所有公共API都有文档注释
- **测试覆盖**：单元测试和集成测试覆盖核心功能

#### 发布流程

1. **版本更新**：更新Cargo.toml版本号
2. **变更日志**：记录新功能、修复、破坏性变更
3. **测试验证**：运行完整测试套件
4. **文档生成**：生成最新API文档
5. **发布准备**：准备发布说明和示例

### 贡献指南

#### 提交规范

- 提交信息格式：`type(scope): description`
- 类型：feat、fix、docs、style、refactor、test、chore
- 描述：简洁明了，说明变更内容

#### 代码审查

- 架构一致性：遵循分层架构原则
- 性能影响：评估对性能的影响
- 安全性：检查潜在的安全风险
- 可维护性：代码是否易于理解和维护

> 本文档持续更新，建议所有开发者优先查阅本文件以理解整体架构与开发规范。
